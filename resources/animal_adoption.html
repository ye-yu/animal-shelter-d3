<!DOCTYPE html>
<meta charset="utf-8">

<!-- stylesheet -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous">
<link rel="stylesheet"
      href="../css/master.css">
<link rel="stylesheet"
      href="../css/animal_adoption.css">

<body>

</body>
<div class="container-fluid">
  <h1 class='vis-title text-center'>Percentage of animal adoption over months</h1>
</div>
  <svg id="adoption"></svg>
<!-- javascript -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"
			  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
			  crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="../js/index.js"></script>
<script>
d3.csv('adoption_month.csv').then(data => {

  /* util functions */
  function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
    const angleInRadians = (angleInDegrees-90) * Math.PI / 180.0;

    return {
      x: centerX + (radius * Math.cos(angleInRadians)),
      y: centerY + (radius * Math.sin(angleInRadians))
    };
  }


  function describeSector(x, y, radius, startAngle, endAngle){
    const start = polarToCartesian(x, y, radius, endAngle);
    const end = polarToCartesian(x, y, radius, startAngle);

    const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

    const d = [
      "M", x, y,
      "L", start.x, start.y,
      "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
      "Z"
    ].join(" ");

    return d;
  }


  function describeArchedSector(x, y, innerRadius, outerRadius, startAngle, endAngle) {
    const innerSector = {
      start: polarToCartesian(x, y, innerRadius, endAngle),
      end: polarToCartesian(x, y, innerRadius, startAngle)
    }

    const outerSector = {
      start: polarToCartesian(x, y, outerRadius, endAngle),
      end: polarToCartesian(x, y, outerRadius, startAngle)
    }

    const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";

    return [
      "M", innerSector.start.x, innerSector.start.y,
      "L", outerSector.start.x, outerSector.start.y,
      "A", outerRadius, outerRadius, 0, largeArcFlag, 0, outerSector.end.x, outerSector.end.y,
      "L", innerSector.end.x, innerSector.end.y,
      "A", innerRadius, innerRadius, 0, largeArcFlag, 1, innerSector.start.x, innerSector.start.y,
      "Z"
    ].join(" ");
  }

  data = data.map(row => {
    let year = +row['year'];
    let month = +row['month'];
    let isAdopted = row['isAdopted'] == "True";
    let species = row['species'];
    return {
      year: year,
      month: month,
      isAdopted: isAdopted,
      species: species
    };
  });

  console.log(data);

  /* data transformation */
  let totalAnimals = data.reduce((acc, d) => {
    let found = acc.find(a => a.year === d.year && a.month === d.month);
    if (!found) {
      acc.push({year:d.year, month: d.month, data: [d.isAdopted]});
    }
    else {
      found.data.push(d.isAdopted);
    }
    return acc;
  }, []);

 	totalAnimals = totalAnimals.map(row => {
    let sum = row.data.length;
    let adopted = row.data.filter(x => x).length / sum;
    let notAdopted = 1 - adopted;
    return {
      year: row.year,
      month: row.month,
      adopted: adopted,
      notAdopted: notAdopted
    }
  });

  console.log(totalAnimals);

  let species = data.reduce((acc, d) => {
    let found = acc.find(a => a.year === d.year && a.species === d.species && a.month === d.month);
    if (!found) {
      acc.push({year:d.year, month: d.month, species: d.species, data: [d.isAdopted]});
    }
    else {
      found.data.push(d.isAdopted);
    }
    return acc;
  }, []);


  let cats = species.filter(x => x.species == 'Dog').map(row => {
    let sum = row.data.length;
    let adopted = row.data.filter(x => x).length / sum;
    let notAdopted = 1 - adopted;
    return {
      year: row.year,
      month: row.month,
      adopted: adopted,
      notAdopted: notAdopted
    }
  });
  console.log(species);

  let svg = d3.select("#adoption")
  .attr('width', $(window).width(1000))
  .attr('height', $(window).height(450));
    // set circle properties
  let sectorAngle = 360 / cats.length;
  let smallRadius = 100;
  let radius = 200;
  let smallCircleMargin = 10;
    // set scaling function
  let scaleSmallRadius = d3.scaleLinear()
  .domain([0, 1])
  .range([0, smallRadius]);

  // insert data for inner sector
  svg.selectAll('path.adoption-cat-inner-circle')
  .data(cats)
  .enter()
  .append('path')
  .attr('class', 'adoption-cat-inner-circle')
  .attr('fill', (row, index) => {
    if (index % 2 == 0) {
	    return '#253';
    }
    return '#352';
  })
  .attr('d', (row, index) => {
    let offset = 0.5;
    let sectorRadius = scaleSmallRadius(row.notAdopted);
    let startAngle = index * sectorAngle + offset;
    let endAngle = (index + 1) * sectorAngle;
    let cx = 2 * radius + smallRadius + smallCircleMargin;
    let cy = smallRadius + smallCircleMargin;
    return describeSector(cx, cy, sectorRadius, startAngle, endAngle);
  });


    // insert data for outer sector
  svg.selectAll('path.adoption-cat-outer-circle')
  .data(cats)
  .enter()
  .append('path')
  .attr('class', 'adoption-cat-outer-circle')
  .attr('fill', row => {
    if (row.year == 2017) {
      return '#cc7';
    }
    if (row.year == 2018) {
      return '#cd8';
    }
    return '#cb6';

  })
  .attr('d', (row, index) => {
    let offset = 0.5;
    let sectorRadius = scaleSmallRadius(row.notAdopted);
    let outerRadius = smallRadius;
    let startAngle = index * sectorAngle + offset;
    let endAngle = (index + 1) * sectorAngle;
    let cx = 2 * radius + smallRadius + smallCircleMargin;
    let cy = smallRadius + smallCircleMargin;
    return describeArchedSector(cx, cy, sectorRadius, outerRadius, startAngle, endAngle);
  });

  svg.selectAll('text.adoption-cat-text')
  .data(cats)
  .enter()
  .append('text')
  .attr('class', 'adoption-cat-text small')
  .attr('x', (row, index) => {
    let angle = index * sectorAngle + 0.5 * sectorAngle;
    let cx = 2 * radius + smallRadius + smallCircleMargin;
    let cy = smallRadius + smallCircleMargin;
    let position = polarToCartesian(cx, cy, smallRadius, angle);
    return position.x;
  })
  .attr('y', (row, index) => {
    let angle = index * sectorAngle + 0.5 * sectorAngle;
    let cx = 2 * radius + smallRadius + smallCircleMargin;
    let cy = smallRadius + smallCircleMargin;
    let position = polarToCartesian(cx, cy, smallRadius + 5, angle);
    return position.y;
  })
  .attr('text-anchor', (row, index) => {
    let angle = index * sectorAngle + 0.5 * sectorAngle;
    if (angle > 180) {
      return 'end';
    }
    return 'start';
  })
  .style('font-size', '0.55em')
  .text(row => `Y${row.year}M${row.month}`);

});
</script>
