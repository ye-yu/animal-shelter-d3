<!DOCTYPE html>
<meta charset="utf-8">

<!-- stylesheet -->
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous">
<link rel="stylesheet"
      href="../css/master.css">

<style media="screen">
  .title-border {
    border-top: solid gray 3px;
    border-bottom: solid gray 3px;
  }

  .btn-xs {
    font-size: 0.75em;
    padding: 3px 5px;
  }

  .btn-compact {
    background-color: #f7f7f7;
    border: solid #aaa 1px;
  }

  .btn-compact.active {
    background-color: #eee;
    border: solid #666 1px;
  }

  .border-top-thick {
    border-top: solid gray 2px;
  }

  .border-bottom-thick {
    border-bottom: solid gray 2px;
  }

</style>
<!-- body -->
<body class="my-5 vis-body">
  <div class="container-fluid" id="where-do-they-come-from">
    <div class="mx-auto px-2 py-2 h2 vis-title text-center text-capitalize text-dark title-border"
         style="width:60%">
      Where do they come from?
      <div class="h6 mt-3 vis-body">
        Stacked line chart of the animal intake count over the
        quarter of the year &amp; their intake reason in
        <a href="https://bloomington.in.gov/animal-shelter"
        target="_blank">
          Animal Care & Control, Bloomington, Indiana
        </a>
      </div>
    </div>
  </div>
  <div class="container mt-3">
    <div class="row flex-lg-row flex-column-reverse">
      <div class="col-lg-9" id="wdtcm-container">
        <svg id="wdtcm-graph">
        </svg>
      </div>
      <div class="col-lg-3">
        <div class="text-center bg-light border border-rounded py-2 mb-2 vis-body align-middle mt-3" style="font-size:0.75em">
          <b>View by:</b>
          <div class="btn-group ml-1 btn-group-toggle" data-toggle="buttons">
            <label class="btn btn-compact btn-xs active">
              <input type="radio" name="view-by" id="wdtcm-count" autocomplete="off" checked>
              Count
            </label>
            <label class="btn btn-compact btn-xs">
              <input type="radio" name="view-by" id="wdtcm-percentage" autocomplete="off">
              Percentage
            </label>
          </div>
        </div>
        <ul class="list-group vis-body border-top border-bottom my-4" id="wdtcm-legend-container">
          <li class="list-group-item text-center py-2 font-weight-bold border-0">Legend</li>
        </ul>
        <div class="vis-body text-center small" id="wdtcm-instruction">
          <span class="action font-weight-bold">Hover over</span> the area or
          <span class="action font-weight-bold">change the y-axis view</span> by clicking the option
          above to look at the elaboration of the data.
        </div>
      </div>
    </div>
    <div class="row mt-2 py-3 border-top-thick border-bottom-thick">
      <div class="col text-center" id="wdtcm-description">
      </div>
    </div>
  </div>
</body>

<!-- javascript -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"
			  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
			  crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="../js/index.js"></script>
<script type="text/javascript">
"use strict";

function updateDescription(text, focus=true) {
  $("#wdtcm-description").html(text);
  if (focus) {
    window.location.hash = "where-do-they-come-from";
  }
}

window.onload=() => {
  let containerWidth=$('#wdtcm-container').width();
  let containerHeight=containerWidth*0.5;
  containerHeight=0.75*containerHeight;

  let svg = d3.select('svg#wdtcm-graph');

  let xCoverage=0.8;
  let yCoverage=0.7;
  let graphDimension={
    width:containerWidth*xCoverage,
    height:containerHeight*yCoverage,
    marginX:0.5*(containerWidth-containerWidth*xCoverage),
    marginY:0.5*(containerHeight-containerHeight*yCoverage),
    offsetTop:40
  };

  let wdtcmEvents = {
    viewBy: 'count'
  };

  println(graphDimension);
  let yScale = d3.scaleLinear();
  let xScale = d3.scaleLinear();
  d3.json("intakes.json")
    .then(data => {

      /* calculate y-axis scale */
      // get max over all quarters
      // convert to tuples
      let totalOverQuarter=[];
      for(let i in data) {
        totalOverQuarter.push(data[i]['Total']);
      }
      let maxOverQuarter=d3.max(totalOverQuarter);

      yScale=yScale.domain([1, maxOverQuarter])
                   .range([graphDimension.offsetTop + graphDimension.height + graphDimension.marginY,
                           graphDimension.offsetTop + graphDimension.marginY])
                   .nice();

      /* calculate x-axis scale */
      xScale=xScale.domain([0,
                            Object.keys(data).length - 1])
                    .range([graphDimension.marginX,
                            graphDimension.width + 1.5 * graphDimension.marginX])
                    .nice();

      /* extract the types of intake */
      let types={};
      for(let i in data) {
        let keys = Object.keys(data[i]).filter(e => e !== 'Total');

        for(let j of keys) {
          if (!isinkey(types, j)) {
            types[j] = 0;
          }
          types[j] += data[i][j]['Total'];
        }
      }

      // convert dictionary to tuple and
      // sort descendingly and only take out
      // types
      types=tuplize(types);
      types=types.sort((a, b) => a[1]-b[1]);
      types=types.map(e => e[0]);

      /* stack entries dataset */
      let rows=[];
      let todate = d3.timeParse("%YQ%q");
      for(let i in data) {
        let datum={};
        datum.Time = todate(i);
        for(let reason of types) {
          datum[reason] = 0;
        }

        let reasons = Object.keys(data[i]).filter(e => e !== 'Total');
        for(let reason of reasons) {
          datum[reason] = data[i][reason]['Total'];
        }
        rows.push(datum);
      }

      let stacker = d3.stack()
                      .keys(types);
      let stacked = stacker(rows);

      /* prepare drawing utils */
      let colourScale = d3.scaleLinear()
                         .domain([0, types.length-1])
                         .range([0.25, 0.7]);
      let drawCountArea = d3.area()
                       .x((d, i) => xScale(i))
                       .y0(d => yScale(d[0]))
                       .y1(d => yScale(d[1]));

      let drawPercentageArea = d3.area()
                            .x((d, i) => xScale(i))
                            .y0((d, i) => yScale(d[0]/totalOverQuarter[i] * 100))
                            .y1((d, i) => yScale(d[1]/totalOverQuarter[i] * 100));

      /* draw stacked line char */
      svg.attr('width', containerWidth + 'px')
         .attr('height', (1.1 * (graphDimension.offsetTop + containerHeight)) + 'px')
         .selectAll('path')
         .data(stacked)
         .enter()
         .append('path')
         .attr('class', 'wdtcm-plot')
         .attr('d', s => drawCountArea(s))
         .style('fill', (d, i) => d3.interpolateRdYlBu(colourScale(i)))
         .style("pointer-events", "all")
         .on("mouseover", function(d, i) {
           d3.select(this)
             .style('stroke-width', '2px')
             .style('stroke', 'gray');
           updateDescription(visualisationDescription[wdtcmEvents.viewBy][types[i]], false);
         })
         .on("mouseout", function(d, i) {
           updateDescription(visualisationDescription[wdtcmEvents.viewBy]['default'], false);
           d3.select(this)
             .style('stroke-width', 'none')
             .style('stroke', 'none');
         });

      /* add legend information*/
      let legends = [];
      types.forEach((e, i) => {
        let colour = d3.interpolateRdYlBu(colourScale(i));
        let template = `          <li class="list-group-item py-1 small border-0">
                    <svg height="10px" width="10px">
                      <rect height="100%" width="100%" fill="${colour}">
                    </svg>
                    <div class="d-inline-block pl-1">
                      ${e}
                    </div>
                  </li>`;
        legends.push(template);
      });
      legends.reverse().forEach(e => $('#wdtcm-legend-container').append(e));

      /* add axis */
      svg.append("g")
         .attr('id', 'wdtcm-yaxis')
         .attr('transform', `translate(${graphDimension.marginX}, 0)`)
         .call(d3.axisLeft(yScale));

      svg.append("g")
         .attr('id', 'wdtcm-xaxis')
         .attr('transform', `translate(0, ${graphDimension.offsetTop + graphDimension.marginY + graphDimension.height})`)
         .call(d3.axisBottom(xScale).tickFormat((d) => Object.keys(data)[d]));

      svg.append("text")
         .attr('class', 'vis-body small')
         .attr('id', 'wdtcm-xaxis-label')
         .attr('text-anchor', 'middle')
         .attr('x', `${graphDimension.marginX}px`)
         .attr('y', `${graphDimension.offsetTop + graphDimension.marginY - 20}px`)
         .text('Count');

      svg.append("text")
         .attr('class', 'vis-body small')
         .attr('text-anchor', 'middle')
         .attr('x', `${containerWidth/2}px`)
         .attr('y', `${graphDimension.offsetTop + graphDimension.height + graphDimension.marginY + 40}px`)
         .text('Quarter of the Year');

      /* add chart label */
      svg.append("text")
         .attr('class', 'vis-title h5')
         .attr('text-anchor', 'middle')
         .attr('x', `${containerWidth/2}px`)
         .attr('y', `${graphDimension.offsetTop + 10}px`)
         .text('Animal Intakes Over the Quarter of the Year');

      /* add visualisation description */
      let visualisationDescription = {count:{},percentage:{}};
       // description when view by count
      visualisationDescription['count']['default'] = `The sum of the animal intakes
      showed mountain-shaped line graph over the years. This behaviour is
      seemingly seasonal &ndash; meaning the mountain-shape repeats on every year as shown in the graph. This
      indicates that the season of the year affects the number of intakes of the quarter;
      The animal intake activity increases on every period from the end of the spring
      until mid-summer.`;

      visualisationDescription['count']['Stray'] = `Description of Stray when
      view by count`;

      visualisationDescription['count']['Other Reason'] = `Description of Other Reason when
      view by count`;

      visualisationDescription['count']['Incompatible with owner lifestyle'] = `Description of Owner Lifestyle when
      view by count`;

      visualisationDescription['count']['Litter relinquishment'] = `Description of Litter when
      view by count`;

      visualisationDescription['count']['Moving'] = `Description of Moving when
      view by count`;

      // description when view by percentage
      visualisationDescription['percentage']['default'] = `From the second quarter
      of 2017 onwards, almost 50% of the intakes are purely stray animals while
      20% consist of multiple reasons aggregated as one category. The intake reason
      of owner incompatibility and litter relinquishment behave almost reciprocately
      where the percentage of one increases as the other decreases. Intakes due to
      moving owner grow and drop occasionally while remaining as the 4th top intake reasons.
      `;

      visualisationDescription['percentage']['Stray'] = `Description of Stray when
      view by percentage`;

      visualisationDescription['percentage']['Other Reason'] = `Description of Other Reason when
      view by percentage`;

      visualisationDescription['percentage']['Incompatible with owner lifestyle'] = `Description of Owner Lifestyle when
      view by percentage`;

      visualisationDescription['percentage']['Litter relinquishment'] = `Description of Litter when
      view by percentage`;

      visualisationDescription['percentage']['Moving'] = `Description of Moving when
      view by percentage`;

      updateDescription(visualisationDescription['count']['default'], false);

      /* add action on button click */
      $('#wdtcm-count').click(e => {
        d3.select("#wdtcm-xaxis-label")
          .text("Count");

        yScale=yScale.domain([1, maxOverQuarter])
                     .nice();

        svg.select("g#wdtcm-yaxis")
           .transition()
           .call(d3.axisLeft(yScale));

        d3.selectAll('path.wdtcm-plot')
          .transition()
          .attr('d', s => drawCountArea(s));

        wdtcmEvents.viewBy = 'count';
        updateDescription(visualisationDescription['count']['default']);
      });

      $('#wdtcm-percentage').click(e => {
        d3.select("#wdtcm-xaxis-label")
          .text("Percentage (%)");

        yScale=yScale.domain([0, 100])
                     .nice();

        svg.select("g#wdtcm-yaxis")
           .transition()
           .call(d3.axisLeft(yScale));

        d3.selectAll('path.wdtcm-plot')
          .transition()
          .attr('d', s => drawPercentageArea(s));

        wdtcmEvents.viewBy = 'percentage';
        updateDescription(visualisationDescription['percentage']['default']);
      });
    });
}
</script>
